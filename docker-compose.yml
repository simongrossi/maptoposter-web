services:
  # 1. Reverse Proxy (Gateway)
  nginx:
    image: nginx:alpine
    container_name: maptoposter-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - posters_volume:/app/static/posters
    depends_on:
      - api
      - web

  # 2. Key-Value Store (Broker)
  redis:
    image: redis:alpine
    container_name: maptoposter-redis
    ports:
      - "6379:6379"

  # 3. Task Worker (Heavy Lifting)
  worker:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: maptoposter-worker
    command: celery -A backend.tasks worker --loglevel=info
    volumes:
      - osm_cache:/.cache
      - posters_volume:/app/static/posters
    environment:
      - REDIS_URL=redis://redis:6379/0
      - PYTHONUNBUFFERED=1
    depends_on:
      - redis

  # 4. API (Dispatcher)
  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: maptoposter-api
    command: uvicorn backend.main:app --host 0.0.0.0 --port 8000
    volumes:
      # API doesn't strictly need cache/posters anymore but good for debug
      - posters_volume:/app/static/posters
    environment:
      - REDIS_URL=redis://redis:6379/0
      - PYTHONUNBUFFERED=1
    depends_on:
      - redis

  # 5. Frontend (UI)
  web:
    build:
      context: .
      dockerfile: frontend.Dockerfile
    container_name: maptoposter-web
    environment:
      # Now frontend talks to Nginx or direct API? 
      # Since we are inside docker network, it can talk to API directly for SSR
      # But client-side fetch goes to Nginx.
      # SvelteKit SSR fetch:
      - API_URL=http://api:8000
      # Posters are served by Nginx now, so SvelteKit does NOT need to serve them.
      # But server-side code might check existence? 
      # If we keep the +server.ts proxy, it needs the volume.
      # Ideally we bypass node for files.
      - POSTERS_DIR=/app/static/posters
    volumes:
      - posters_volume:/app/static/posters
    depends_on:
      - api

volumes:
  osm_cache:
  posters_volume:
