services:
  # Backend Python (FastAPI)
  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: maptoposter-api
    ports:
      - "8000:8000"
    volumes:
      # Persist OpenStreetMap cache
      - osm_cache:/.cache
      # Shared volume for generated posters
      - posters_volume:/app/static/posters
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped

  # Frontend SvelteKit
  web:
    build:
      context: .
      dockerfile: frontend.Dockerfile
    container_name: maptoposter-web
    ports:
      - "3000:3000"
    environment:
      # Tell SvelteKit (or server-side code) where API is
      - API_URL=http://api:8000
    depends_on:
      - api
    volumes:
      # Mount the SAME volume so frontend can serve static files generated by backend
      # Note: SvelteKit 'static' folder is usually served at build time. 
      # For dynamic content generated at runtime, we might need a specific route logic or 
      # mount it into the build output path `/app/build/client/posters` or serve via a separate nginx.
      # SIMPLEST SVELTEKIT TRICK: Adapter-node serves `client` assets. 
      # Dynamic files are tricky in pure node-adapter if not in proper place.
      # We will mount it to where the code expects it to check existence.
      # Update: In `+server.ts` or pure python usage, we might serve these files via the API?
      # NO, user asked "backend save in shared folder accessible by frontend".
      # We will map it to /app/build/client/posters if that directory structure holds.
      # OR better: use NGINX in front?
      # FOR NOW: Let's assume SvelteKit adapter-node can serve from a directory if configured, 
      # BUT standard static assets are baked in.
      # Workaround: Mount volume to `build/client/posters` (if it exists) so node server finds them?
      # Actually, `handler.js` (adapter-node) usually serves things in `client` via `sirv` or similar.
      - posters_volume:/app/build/client/posters

volumes:
  osm_cache:
  posters_volume:
